# Milestone 4.3 – Outstanding Issue

State-root / block-hash mismatch detected by `TestRPCGetBlockOrHeader` when the `revm` build-tag is enabled.

---
## 1  Symptom
* First sub-test (header-only request for the **latest** block) already fails.
* Mismatching fields: **`stateRoot`**, **`parentHash`** and derived **`hash`**.
* `gasUsed`, `baseFeePerGas`, receipts-root, tx-root **do** match → gas accounting and receipt translation are fine.

## 2  Root cause
1. The block generator (`core.BlockGen`) executes every transaction with *native* Go-EVM and writes balance/nonce updates **directly** to the live `StateDB`.
2. During chain verification the dispatcher switches to the REVM executor which
   * journals the same balance/nonce changes in its overlay **and then commits them to `StateDB` again** via `GoDatabase.commit`.
3. Each change is therefore applied **twice** → the final trie and thus the state-root diverge.

## 3  Fix plan (journal-only / single-flush)
* Keep REVM writes in the in-memory journal (`pendingBasic`, `pendingStorage`, …) until the end of block processing.
* Add a **single guarded flush** in `state_processor.Process`:
  ```go
  if revmbridge.HasPendingOverlay(statedb) { // true only in verification path
      revmbridge.FlushPendingFor(statedb)
  }
  ```
  – Generation path (BlockGen) passes a *plain* `StateDB`; guard is `false`, so no double-write.
* `flushPending()` skips placeholder byte-code and balance/nonce writes that are already equal.

---
## 4  Why this is still Milestone 4.3
* Milestone 4.4 (gas/refund parity) would manifest as `gasUsed` mismatches – **not** the case here.
* Milestone 4.5 (precompiles) is irrelevant: no precompile calls in the test blocks.
* Therefore the bug belongs to 4.3's deliverable: "block-level journal & commit with correct receipts / state".

---
## 5  FAQ / clarifications
**Q – Should we wrap `BlockGen`'s `StateDB` with the REVM overlay instead?**  
A – Technically possible but counter-productive: the generator relies on immediate state writes and is used for both Go-EVM and REVM comparison tests. Wrapping it would require per-tx flushes (negating the journal benefit) and remove engine independence. A dedicated REVM-based generator can be introduced later if needed.

**Q – Could unfinished Milestones 4.4 or 4.5 cause this failure?**  
A – No. Mismatch is purely in state root; gas accounting and precompile handling already match.

---
## 6  Next steps
- [ ] Implement the guarded flush in `state_processor.go`.
- [ ] Ensure `flushPending()` skips zero-byte placeholder code and duplicate balance/nonce writes.
- [ ] Re-run `go test ./internal/ethapi -run TestRPCGetBlockOrHeader -tags=revm` → expect green.
- [ ] When green, Milestone 4.3 can be closed and we can move to 4.4. 